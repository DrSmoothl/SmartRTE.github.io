<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>aff变速</title>
		<link href="css/AffSpeedChanger.css" type="text/css" rel="stylesheet"/>
		<!-- <script src="js/jquery-3.6.1.min.js"></script> -->
		<script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
		<!-- <script src="js/AffSpeedChanger.js"></script> -->
	</head>
	<body>
		<label for="time-factor">速率</label>
		<input type="number" value="1.00" id="time-factor"/>
		<input type="file" id="aff-upload"/>
		<button id="excecute">执行变速</button>
		<button id="copy">复制到剪贴板</button><br />
		<textarea id="text-input" placeholder="在此粘贴aff内容(片段或全部)" style="display: inline-block; position:relative; left: 0; width: 48%; height: 80vh;"></textarea>
		<textarea id="res" placeholder="变速后的aff会显示在这里" style="width: 48%; height: 80vh; display: inline-block"></textarea>
	</body>
	<script>
		let content = '';
		let slice = '';
		let lines = '';
		let timeFactor = 1.0;
		let inTimingGroupCounter = 0;
		let timingCounter = 0;
		let tapCounter = 0;
		let arcCounter = 0;
		let sceneCounter = 0;
		let cameraCounter = 0;
		$(document).ready(function() {
			console.log("ready");
			$('#time-factor').on('input', function(e) {
				timeFactor = $('#time-factor').val();
				console.log(timeFactor);
			});
			$('#text-input').on('input', function() {
				if ($('#text-input').val() != null) {
					content = $('#text-input').val();
					lines = content.split("\n");
					let newlines = [];
					lines.forEach(function(line, index) {
						newline = checkLine(line);
						console.log("0000newline=" + newline);
						newlines.push(newline);
					});
					// console.log(lines);
					let newContent = newlines.join("\r\n");
					console.log("timingCounter:" + timingCounter);
					console.log("inTimingGroupCounter:" + inTimingGroupCounter);
					console.log("arcCounter:" + arcCounter);
					$('#res').text(newContent);
				}
			})
			$('#aff-upload').on('change', function(event) {
				const file = event.target.files[0];
				if (file) {
					let reader = new FileReader();
					reader.onload = function(e) {
						content = e.target.result;
						// console.log(content);
						lines = content.split("\r\n");
						// console.log(lines);
						let newlines = [];
						lines.forEach(function(line, index) {
							newline = checkLine(line);
							console.log("0000newline=" + newline);
							newlines.push(newline);
						});
						// console.log(lines);
						let newContent = newlines.join("\r\n");
						console.log("timingCounter:" + timingCounter);
						console.log("inTimingGroupCounter:" + inTimingGroupCounter);
						console.log("arcCounter:" + arcCounter);
						$('#res').text(newContent);
					};
					reader.readAsText(file, 'UTF-8');
				}
			});
		
			$('#copy').click(async function() {
				try {
					// 复制内容到剪贴板
					await navigator.clipboard.writeText($('#res').val());
		
					// 提示用户复制成功（可选）
					alert('已成功复制到剪贴板！');
				} catch (err) {
					console.error('Failed to copy: ', err);
					alert('复制到剪贴板失败，请手动复制');
				}
			});
		
		})
		
		
		function checkLine(line) {
			// console.log("currentline=" + line);
			if (line.startsWith("  ")) {
				inTimingGroupCounter++;
				let subline = line.substring(2);
				let newline = "  " + checkLine(subline);
				return newline;
			} else if (line.startsWith("timing(")) {
				// console.log(line);
				timingCounter++;
				let newline = '';
				let regex = /timing\((-?\d+),(-?\d+\.\d{2}),(-?\d+\.\d{2})\);/;
				let match = line.match(regex);
				if (match) {
					let t = parseInt(match[1]) / timeFactor;
					let bpm = parseFloat(match[2]) * timeFactor;
					let newline = "timing(" + parseInt(t) + "," + bpm.toFixed(2) + "," + match[3] + ");";
					// console.log("new:"+newline);
					return newline;
				}
			} else if (line.startsWith("(")) {
				let regex = /\((\d+),(\d+)\);/;
				let match = line.match(regex);
				if (match) {
					let t = parseInt(match[1]) / timeFactor;
					let newline = "(" + parseInt(t) + "," + match[2] + ");";
					return newline;
				}
			} else if (line.startsWith("hold(")) {
				let regex = /hold\((\d+),(\d+),(\d+)\);/;
				let match = line.match(regex);
				if (match) {
					let t1 = parseInt(match[1]) / timeFactor;
					let t2 = parseInt(match[2]) / timeFactor;
					let newline = "hold(" + parseInt(t1) + "," + parseInt(t2) + "," + match[3] + ");";
					return newline;
				}
			} else if (line.startsWith("arc(")) {
				// console.log("--arc");
				arcCounter++;
				let newline = handleArcTap(line);
				return newline;
			} else if (line.startsWith("scenecontrol(")) {
				sceneCounter++;
				let newline = handleSceneControl(line);
				return newline;
			} else if (line.startsWith("camera(")) {
				cameraCounter++;
				let newline = handleCamera(line);
				return newline;
			} else {
				return line;
			}
		}
		
		function handleCamera(line) {
			let t = parseInt(line.substring(7, line.indexOf(",")));
			let duration = parseFloat(line.substring(line.lastIndexOf(",") + 1, line.length - 2));
			let newline = line.substring(0, 7) + parseInt(t / timeFactor) + line.substring(line.indexOf(","), line.lastIndexOf(",") +
				1) + parseInt(duration / timeFactor) + ");";
			return newline;
		}
		
		function handleArcTap(line) {
			// let inputStr = 'arc(126934,127913,0.00,1.00,b,1.00,1.00,0,none,true)[arctap(127235),arctap(127612)];';
			let totalLength = line.length;
			let idx = line.lastIndexOf("arctap");
			while (idx !== -1) {
				let p = line.substring(0, idx) + "aaaaaaa";
				let t = parseInt(parseInt(line.substring(idx + 7, line.lastIndexOf(")"))) / timeFactor) + "#";
				let r = line.substring(line.lastIndexOf(")") + 1, line.length);
				line = p + t + r;
				idx = line.lastIndexOf("arctap");
				// console.log("currentARCline=" + line);
			}
			let regex = /arc\((\d+),(\d+),/;
			let match = line.match(regex);
			if (match) {
				let t1 = parseInt(match[1]) / timeFactor;
				let t2 = parseInt(match[2]) / timeFactor;
				let r = line.substring(4 + match[1].length + 1 + match[2].length, line.length);
				// console.log("r="+r.replaceAll("aaaaaaa","arctap(").replaceAll("#",")"));
				r = r.replaceAll("aaaaaaa", "arctap(").replaceAll("#", ")");
				let newline = "arc(" + parseInt(t1) + "," + parseInt(t2) + r;
				// console.log("newarcline="+newline);
				return newline;
			}
		
			return line;
		}
		
		function handleSceneControl(line) {
			if (line.indexOf("trackhide") !== -1 || line.indexOf("trackshow") !== -1) {
				let p = line.substring(0, 13);
				let r = line.substring(line.length - 12, line.length);
				let t = parseInt(parseInt(line.substring(13, line.length - 12)) / timeFactor);
				let newline = p + t + r;
				return newline;
			} else if (line.indexOf("trackdisplay") !== -1) {
				let regex = /scenecontrol\((\d+),[^,]+,(-?\d+(\.\d+)?),(\d+)\);/;
				let match = line.match(regex);
		
				if (match) {
					let t = parseInt(parseInt(match[1] / timeFactor));
					let param1 = (parseFloat(match[2]) / timeFactor).toFixed(2);
					let param2 = parseInt(match[4]);
		
					let newline = "scenecontrol(" + t + ",trackdisplay," + param1 + "," + param2 + ");"
					return newline;
				}
			} else if (line.indexOf("redline") !== -1) {
				let regex = /scenecontrol\((\d+),[^,]+,(-?\d+(\.\d+)?),(\d+)\);/;
				let match = line.match(regex);
		
				if (match) {
					let t = parseInt(parseInt(match[1] / timeFactor));
					let param1 = (parseFloat(match[2]) / timeFactor).toFixed(2);
					let param2 = parseInt(match[4]);
		
					let newline = "scenecontrol(" + t + ",redline," + param1 + "," + param2 + ");"
					return newline;
				}
			} else if (line.indexOf("arcahvdistort") !== -1) {
				let regex = /scenecontrol\((\d+),[^,]+,(-?\d+(\.\d+)?),(\d+)\);/;
				let match = line.match(regex);
		
				if (match) {
					let t = parseInt(parseInt(match[1] / timeFactor));
					let param1 = (parseFloat(match[2]) / timeFactor).toFixed(2);
					let param2 = parseInt(match[4]);
		
					let newline = "scenecontrol(" + t + ",arcahvdistort," + param1 + "," + param2 + ");"
					return newline;
				}
			} else if (line.indexOf("arcahvdebris") !== -1) {
				let regex = /scenecontrol\((\d+),[^,]+,(-?\d+(\.\d+)?),(\d+)\);/;
				let match = line.match(regex);
		
				if (match) {
					let t = parseInt(parseInt(match[1] / timeFactor));
					let param1 = (parseFloat(match[2]) / timeFactor).toFixed(2);
					let param2 = parseInt(match[4]);
		
					let newline = "scenecontrol(" + t + ",arcahvdebris," + param1 + "," + param2 + ");"
					return newline;
				}
			} else if (line.indexOf("hidegroup") !== -1) {
				let t = line.substring(13, line.indexOf(","));
				let newline = line.substring(0, 13) + parseInt(parseInt(t) / timeFactor) + line.substring(line.indexOf(","),
					line.length);
				return newline;
			} else if (line.indexOf("enwidencamera") !== -1) {
				let regex = /scenecontrol\((\d+),[^,]+,(-?\d+(\.\d+)?),(\d+)\);/;
				let match = line.match(regex);
		
				if (match) {
					let t = parseInt(parseInt(match[1] / timeFactor));
					let param1 = (parseFloat(match[2]) / timeFactor).toFixed(2);
					let param2 = parseInt(match[4]);
		
					let newline = "scenecontrol(" + t + ",enwidencamera," + param1 + "," + param2 + ");"
					return newline;
				}
			} else if (line.indexOf("enwidenlanes") !== -1) {
				let regex = /scenecontrol\((\d+),[^,]+,(-?\d+(\.\d+)?),(\d+)\);/;
				let match = line.match(regex);
		
				if (match) {
					let t = parseInt(parseInt(match[1] / timeFactor));
					let param1 = (parseFloat(match[2]) / timeFactor).toFixed(2);
					let param2 = parseInt(match[4]);
		
					let newline = "scenecontrol(" + t + ",enwidenlanes," + param1 + "," + param2 + ");"
					return newline;
				}
			}
		}
		
		function toRound(number, decimal) {
			// console.log(number);
			let multiplier = Math.pow(10, decimal);
			return Math.floor(number * multiplier) / multiplier;
		}
	</script>
</html>